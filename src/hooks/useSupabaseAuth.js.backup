import { useState, useEffect } from 'react';
import { supabase } from '../lib/supabase';

export const useSupabaseAuth = () => {
  const [user, setUser] = useState(null);
  const [loading, setLoading] = useState(false); // ì„ì‹œë¡œ false ì‹œì‘
  const [profile, setProfile] = useState(null);

  // ì‚¬ìš©ì ì„¸ì…˜ í™•ì¸
  useEffect(() => {
    // íƒ€ì„ì•„ì›ƒ ì•ˆì „ì¥ì¹˜: 3ì´ˆ í›„ ê°•ì œë¡œ ë¡œë”© í•´ì œ
    const timeoutId = setTimeout(() => {
      console.warn('âš ï¸ ì¸ì¦ ì´ˆê¸°í™”ê°€ 3ì´ˆë¥¼ ì´ˆê³¼í–ˆìŠµë‹ˆë‹¤. ê°•ì œë¡œ ë¡œë”©ì„ í•´ì œí•©ë‹ˆë‹¤.');
      setLoading(false);
      setUser(null); // íƒ€ì„ì•„ì›ƒ ì‹œ userë„ nullë¡œ ì„¤ì •
    }, 3000);
    // í˜„ì¬ ì„¸ì…˜ ê°€ì ¸ì˜¤ê¸°
    const getSession = async () => {
      console.log('ğŸ” ì„¸ì…˜ ì´ˆê¸°í™” ì‹œì‘...');
      
      try {
        const { data: { session }, error } = await supabase.auth.getSession();
        
        console.log('ğŸ” Supabase ì„¸ì…˜ ê²°ê³¼:', { 
          hasSession: !!session, 
          hasUser: !!session?.user, 
          email: session?.user?.email,
          error: error?.message 
        });
        
        if (error) {
          console.error('âŒ Supabase ì„¸ì…˜ ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨:', error);
          setUser(null);
          setLoading(false);
          clearTimeout(timeoutId);
          return;
        }
        
        setUser(session?.user || null);
        
        if (session?.user) {
          console.log('ğŸ‘¤ ì‚¬ìš©ì ì„¸ì…˜ í™•ì¸ë¨. í”„ë¡œí•„ ë¡œë”© ì‹œì‘...');
          try {
            await fetchProfile(session.user.id);
            console.log('âœ… í”„ë¡œí•„ ë¡œë”© ì™„ë£Œ');
          } catch (profileError) {
            console.error('âŒ í”„ë¡œí•„ ë¡œë”© ì‹¤íŒ¨:', profileError);
            // í”„ë¡œí•„ ë¡œë”© ì‹¤íŒ¨í•´ë„ ë¡œë”©ì€ ì™„ë£Œ
          }
        } else {
          console.log('ğŸšª ì„¸ì…˜ì´ ì—†ìŒ - ë¡œê·¸ì¸ í•„ìš”');
        }
        
        console.log('âœ… ì„¸ì…˜ ì´ˆê¸°í™” ì™„ë£Œ');
        setLoading(false);
        clearTimeout(timeoutId); // ì„±ê³µ ì‹œ íƒ€ì„ì•„ì›ƒ í•´ì œ
      } catch (error) {
        console.error('âŒ ì„¸ì…˜ ì´ˆê¸°í™” ì¤‘ ì¹˜ëª…ì  ì˜¤ë¥˜:', error);
        setUser(null);
        setLoading(false);
        clearTimeout(timeoutId); // ì—ëŸ¬ ì‹œì—ë„ íƒ€ì„ì•„ì›ƒ í•´ì œ
      }
    };

    getSession();

    // ì¸ì¦ ìƒíƒœ ë³€ê²½ ë¦¬ìŠ¤ë„ˆ
    const { data: { subscription } } = supabase.auth.onAuthStateChange(
      async (event, session) => {
        console.log('ğŸ” Auth state changed:', event, 'user:', session?.user?.email, 'session exists:', !!session);
        
        setUser(session?.user || null);
        
        if (session?.user && event === 'SIGNED_IN') {
          console.log('âœ… ë¡œê·¸ì¸ ì„±ê³µ, í”„ë¡œí•„ ë¡œë”© ì¤‘...');
          try {
            await fetchProfile(session.user.id);
            console.log('âœ… í”„ë¡œí•„ ë¡œë”© ì™„ë£Œ');
          } catch (profileError) {
            console.error('âŒ ì¸ì¦ ìƒíƒœ ë³€ê²½ ì‹œ í”„ë¡œí•„ ë¡œë”© ì‹¤íŒ¨:', profileError);
          }
        } else if (event === 'SIGNED_OUT') {
          console.log('ğŸšª ë¡œê·¸ì•„ì›ƒ ì²˜ë¦¬');
          setProfile(null);
        } else {
          console.log('ğŸ”„ ê¸°íƒ€ ì¸ì¦ ìƒíƒœ ë³€ê²½:', event);
          setProfile(null);
        }
        
        setLoading(false);
      }
    );

    return () => {
      subscription.unsubscribe();
      clearTimeout(timeoutId); // ì»´í¬ë„ŒíŠ¸ ì–¸ë§ˆìš´íŠ¸ ì‹œ íƒ€ì„ì•„ì›ƒ ì •ë¦¬
    };
  }, []);

  // í”„ë¡œí•„ ê°€ì ¸ì˜¤ê¸°
  const fetchProfile = async (userId) => {
    console.log('ğŸ‘¤ í”„ë¡œí•„ ë¡œë”© ì‹œì‘ for userId:', userId);
    
    try {
      const { data, error } = await supabase
        .from('profiles')
        .select('*')
        .eq('id', userId)
        .single();

      console.log('ğŸ‘¤ í”„ë¡œí•„ ì¿¼ë¦¬ ê²°ê³¼:', { data, error });

      if (error && error.code !== 'PGRST116') { // PGRST116 = row not found
        console.error('âŒ í”„ë¡œí•„ ê°€ì ¸ì˜¤ê¸° ì˜¤ë¥˜:', error);
        
        // í…Œì´ë¸”ì´ ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ê²½ìš° ë˜ëŠ” ê¸°íƒ€ ì˜¤ë¥˜ ì‹œ ê¸°ë³¸ í”„ë¡œí•„ ì„¤ì •
        console.warn('âš ï¸ í”„ë¡œí•„ ë¡œë”© ì‹¤íŒ¨. ê¸°ë³¸ í”„ë¡œí•„ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.');
        const defaultProfile = {
          id: userId,
          role: 'user',
          name: 'User',
          email: '',
          team: 'ì¼ë°˜íŒ€'
        };
        console.log('ğŸ”§ ê¸°ë³¸ í”„ë¡œí•„ ì„¤ì •:', defaultProfile);
        setProfile(defaultProfile);
        return;
      }

      if (data) {
        console.log('âœ… í”„ë¡œí•„ ë¡œë”© ì„±ê³µ:', data);
        setProfile(data);
      } else {
        console.warn('âš ï¸ í”„ë¡œí•„ ë°ì´í„°ê°€ ë¹„ì–´ìˆìŒ. ê¸°ë³¸ í”„ë¡œí•„ ì‚¬ìš©');
        const defaultProfile = {
          id: userId,
          role: 'user',
          name: 'User',
          email: '',
          team: 'ì¼ë°˜íŒ€'
        };
        setProfile(defaultProfile);
      }
    } catch (error) {
      console.error('âŒ í”„ë¡œí•„ fetch ì¹˜ëª…ì  ì—ëŸ¬:', error);
      // ì‹¬ê°í•œ ì˜¤ë¥˜ ë°œìƒ ì‹œì—ë„ ê¸°ë³¸ í”„ë¡œí•„ ì„¤ì •
      const defaultProfile = {
        id: userId,
        role: 'user', 
        name: 'User',
        email: '',
        team: 'ì¼ë°˜íŒ€'
      };
      console.log('ğŸ”§ ì—ëŸ¬ í›„ ê¸°ë³¸ í”„ë¡œí•„ ì„¤ì •:', defaultProfile);
      setProfile(defaultProfile);
    }
  };

  // íšŒì›ê°€ì…
  const signUp = async (email, password, name, team) => {
    try {
      setLoading(true);
      
      // 1. Supabase Authì— ì‚¬ìš©ì ìƒì„±
      const { data, error } = await supabase.auth.signUp({
        email,
        password,
        options: {
          data: {
            name,
            team
          }
        }
      });

      if (error) throw error;

      // 2. í”„ë¡œí•„ í…Œì´ë¸”ì— ì¶”ê°€ ì •ë³´ ì €ì¥
      if (data.user) {
        const { error: profileError } = await supabase
          .from('profiles')
          .insert([{
            id: data.user.id,
            name,
            team,
            email,
            role: 'user',
            registered_at: new Date().toISOString()
          }]);

        if (profileError) {
          console.error('í”„ë¡œí•„ ìƒì„± ì˜¤ë¥˜:', profileError);
        }
      }

      return { data, error: null };
    } catch (error) {
      console.error('íšŒì›ê°€ì… ì˜¤ë¥˜:', error);
      return { data: null, error };
    } finally {
      setLoading(false);
    }
  };

  // ë¡œê·¸ì¸
  const signIn = async (email, password) => {
    try {
      console.log('ğŸ”‘ ë¡œê·¸ì¸ ì‹œë„:', email);
      setLoading(true);
      
      const { data, error } = await supabase.auth.signInWithPassword({
        email,
        password
      });

      if (error) {
        console.error('âŒ ë¡œê·¸ì¸ ì‹¤íŒ¨:', error);
        throw error;
      }
      
      console.log('âœ… Supabase ë¡œê·¸ì¸ ì„±ê³µ:', data?.user?.email);
      return { data, error: null };
    } catch (error) {
      console.error('âŒ ë¡œê·¸ì¸ ì˜¤ë¥˜:', error);
      return { data: null, error };
    } finally {
      setLoading(false);
    }
  };

  // ë¡œê·¸ì•„ì›ƒ
  const signOut = async () => {
    try {
      setLoading(true);
      
      const { error } = await supabase.auth.signOut();
      if (error) throw error;
      
      setUser(null);
      setProfile(null);
      
      return { error: null };
    } catch (error) {
      console.error('ë¡œê·¸ì•„ì›ƒ ì˜¤ë¥˜:', error);
      return { error };
    } finally {
      setLoading(false);
    }
  };

  // ë¹„ë°€ë²ˆí˜¸ ë³€ê²½
  const updatePassword = async (newPassword) => {
    try {
      const { error } = await supabase.auth.updateUser({
        password: newPassword
      });

      if (error) throw error;
      
      // must_change_password í”Œë˜ê·¸ ì œê±°
      if (profile) {
        await supabase
          .from('profiles')
          .update({ must_change_password: false })
          .eq('id', user.id);
      }
      
      return { error: null };
    } catch (error) {
      console.error('ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ì˜¤ë¥˜:', error);
      return { error };
    }
  };

  // í”„ë¡œí•„ ì—…ë°ì´íŠ¸
  const updateProfile = async (updates) => {
    try {
      const { error } = await supabase
        .from('profiles')
        .update(updates)
        .eq('id', user.id);

      if (error) throw error;
      
      // ë¡œì»¬ ìƒíƒœ ì—…ë°ì´íŠ¸
      setProfile(prev => ({ ...prev, ...updates }));
      
      return { error: null };
    } catch (error) {
      console.error('í”„ë¡œí•„ ì—…ë°ì´íŠ¸ ì˜¤ë¥˜:', error);
      return { error };
    }
  };

  // ë¹„ë°€ë²ˆí˜¸ ì¬ì„¤ì • ìš”ì²­ (Supabase Auth ì‚¬ìš©)
  const requestPasswordReset = async (email) => {
    try {
      const { error } = await supabase.auth.resetPasswordForEmail(email, {
        redirectTo: `${window.location.origin}/reset-password`,
      });

      if (error) throw error;
      
      return { success: true };
    } catch (error) {
      console.error('ë¹„ë°€ë²ˆí˜¸ ì¬ì„¤ì • ìš”ì²­ ì˜¤ë¥˜:', error);
      return { success: false, error: error.message };
    }
  };

  return {
    user,
    profile,
    loading,
    signUp,
    signIn,
    signOut,
    updatePassword,
    updateProfile,
    requestPasswordReset,
    // ê¸°ì¡´ useAuthì™€ í˜¸í™˜ì„±ì„ ìœ„í•œ ë³„ì¹­ë“¤
    isAuthenticated: !!user,
    isAdmin: profile?.role === 'admin',
    mustChangePassword: profile?.must_change_password || false
  };
};